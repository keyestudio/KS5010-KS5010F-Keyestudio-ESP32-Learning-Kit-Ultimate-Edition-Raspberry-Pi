# Project 30：Ultrasonic Ranger

1.  Introduction：  
    The HC-SR04 ultrasonic sensor is a very affordable distance
    sensor, mainly used for obstacle avoidance in various robotic
    projects. It is also used for water level sensing and even as a
    parking sensor. We treat the ultrasonic sensors as bat's eyes,, in
    the dark, bats can still identify objects in front of them and
    directions through ultrasound. In this project, we use ESP32 to
    control a ultrasonic sensor and LEDs to simulate ultrasonic
    rangefinder.

2.  Components：

<table>
<tbody>
<tr class="odd">
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5010-KS5010F-Keyestudio-ESP32-Learning-Kit-Ultimate-Edition-Raspberry-Pi/master/media/56053f7126905c6def63919c661d5c0a.jpeg" style="width:1.59722in;height:0.77986in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5010-KS5010F-Keyestudio-ESP32-Learning-Kit-Ultimate-Edition-Raspberry-Pi/master/media/e380dd26e4825be9a768973802a55fe6.png" style="width:0.75972in;height:1.8625in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5010-KS5010F-Keyestudio-ESP32-Learning-Kit-Ultimate-Edition-Raspberry-Pi/master/media/85df6831220dec7d43a68bfc9b7382cb.png" style="width:1.45764in;height:0.96319in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5010-KS5010F-Keyestudio-ESP32-Learning-Kit-Ultimate-Edition-Raspberry-Pi/master/media/7eb361d680dfa351f07f8527aeb37abd.png" style="width:0.275in;height:1.17361in" /></td>
<td></td>
</tr>
<tr class="even">
<td>ESP32*1</td>
<td>Breadboard*1</td>
<td>Ultrasonic Sensor*1</td>
<td>Red LED*4</td>
<td></td>
</tr>
<tr class="odd">
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5010-KS5010F-Keyestudio-ESP32-Learning-Kit-Ultimate-Edition-Raspberry-Pi/master/media/1fbdfe0569327d9a42600a54336bf7b5.png" style="width:1.38819in;height:1.15833in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5010-KS5010F-Keyestudio-ESP32-Learning-Kit-Ultimate-Edition-Raspberry-Pi/master/media/098a2730d0b0a2a4b2079e0fc87fd38b.png" style="width:1.22639in;height:0.49236in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5010-KS5010F-Keyestudio-ESP32-Learning-Kit-Ultimate-Edition-Raspberry-Pi/master/media/e9a8d050105397bb183512fb4ffdd2f6.png" style="width:0.90694in;height:0.90139in" /></td>
<td><img src="https://raw.githubusercontent.com/keyestudio/KS5010-KS5010F-Keyestudio-ESP32-Learning-Kit-Ultimate-Edition-Raspberry-Pi/master/media/7dcbd02995be3c142b2f97df7f7c03ce.png" style="width:0.99028in;height:0.52986in" /></td>
<td></td>
</tr>
<tr class="even">
<td>M-F Dupont Wires</td>
<td>220ΩResistor*4</td>
<td>Jumper Wires</td>
<td>USB Cable*1</td>
<td></td>
</tr>
</tbody>
</table>

3.  Component knowledge：

**HC-SR04 Ultrasonic Sensor :** Like bats, sonar is used to determine
the distance to an object. It provides accurate non-contact range
detection, high-precision and stable readings. Its operation is not
affected by sunlight or black materials, just like a precision camera
(acoustically softer materials like cloth are difficult to detect). It
has an ultrasonic transmitter and receiver.

![](/media/e6f6037071e434febf7090b56ac35802.png)

In front of the ultrasonic sensor are two metal cylinders, these are the
converters. The converters convert the mechanical energy into an
electrical signal. In the ultrasonic sensor, there are transmitting
converters and receiving converters. The transmitting converter converts
the electric signal into an ultrasonic pulse, and the receiving
converter converts the reflected ultrasonic pulse back to an electric
signal. If you look at the back of the ultrasonic sensor, you will see
an IC behind the transmitting converter, which controls the transmitting
converter. There is also an IC behind the receiving converter, which is
a quad operational amplifier that amplifies the signal generated by the
receiving converter into a signal large enough to be transmitted to the
Microcontroller.

Sequence diagrams:

The figure shows the sequence diagram of the HC-SR04. To start the
measurement, the Trig of SR04 must receive at least 10us high pulse
(5V), which will activate the sensor to emit 8 cycles of 40kHz
ultrasonic pulses, and wait for the reflected ultrasonic pulses. When
the sensor detects ultrasound from the receiver, it sets the Echo pin to
high (5V) and delays it by one cycle (width), proportional to the
distance. To get the distance, measure the width of the Echo pin.

![](/media/4114885ac4b6214953e3224d8c1d52c4.png)

Time = Echo pulse width, its unit is “us” (microseconds)

Distance in centimeters = time / 58

Distance in inches = time / 148

4.  Read the distance value of the ultrasonic sensor:
    
    We will start with a simple ultrasonic ranging and print the
    measured distance.
    
    ![](/media/db430baa07e2e4d9ac9efca1950b953a.jpeg)
    
    The HC-SR04 ultrasonic sensor has four pins, they are Vcc, Trig,
    Echo and GND. The Vcc pin provides the power source for generating
    ultrasonic pulses and is connected to Vcc (+5V). The GND pin is
    grounded. The Trig pin is where the Arduino sends a signal to start
    the ultrasonic pulse. The Echo pin is where the ultrasonic sensor
    sends information about the duration of the ultrasonic pulse to the
    Control board. Wiring as shown below:

![](/media/a8d408be3629a2d288dbb30bd60007af.png)

You can open the code we provide:

The code used in this project is saved in folder **“3. Raspberry Pi
System\\C\_Tutorial\\2.Projects\\Project 30：Ultrasonic Ranger\\Project
30.1\_Ultrasonic\_Ranging”**.

    //**********************************************************************************
    /*  
     * Filename    : Ultrasonic Ranging
     * Description : Use the ultrasonic module to measure the distance.
     * Auther      : http//www.keyestudio.com
    */
    const int TrigPin = 13; // define TrigPin
    const int EchoPin = 14; // define EchoPin.
    int duration = 0; // Define the initial value of the duration to be 0
    int distance = 0;//Define the initial value of the distance to be 0
    void setup() 
    {
      pinMode(TrigPin , OUTPUT); // set trigPin to output mode
      pinMode(EchoPin , INPUT); // set echoPin to input mode
      Serial.begin(115200);  // Open serial monitor at 115200 baud to see ping results.
    }
    void loop()
    {
     // make trigPin output high level lasting for 10μs to triger HC_SR04 
      digitalWrite(TrigPin , HIGH);
      delayMicroseconds(10);
      digitalWrite(TrigPin , LOW);
      // Wait HC-SR04 returning to the high level and measure out this waitting time
      duration = pulseIn(EchoPin , HIGH);
      // calculate the distance according to the time
      distance = (duration/2) / 28.5 ;
      Serial.print("Distance: ");
      Serial.print(distance); //Serial port print distance value
      Serial.println("cm");
      delay(300); // Wait 100ms between pings (about 20 pings/sec).
    }
    //**********************************************************************************


Compile and upload the code to ESP32, after the code is uploaded
successfully, power up with a USB cable, open the serial monitor and set
the baud rate to 115200. You need to press the reset button on the ESP32
mainboard first, and then you will see that the serial port monitor
window will print out the distance between the ultrasonic sensor and the
object.

![](/media/4927b524b1ceb2647d886c3797245fa5.png)

5.  Wiring diagram of the ultrasonic rangefinder：
    
    Next, we will use ESP32 to control an ultrasonic sensor and 4 LEDs
    to simulate ultrasonic rangefinder. Connect the line as shown below：
    
    ![](/media/910ed1be8be94411a090afb95af86d1a.png)

6.  Project code：

You can open the code we provide:

The code used in this project is saved in folder **“3. Raspberry Pi
System\\C\_Tutorial\\2.Projects\\Project 30：Ultrasonic
Ranger\\Project\_30.2\_Ultrasonic\_Ranger”**.

    //**********************************************************************************
    /*  
     * Filename    : Ultrasonic Ranger
     * Description : four leds are controlled by ultrasonic ranging.
     * Auther      : http//www.keyestudio.com
    */
    const int TrigPin = 13;    // define TrigPin
    const int EchoPin = 14;    // define EchoPin.
    const int PIN_LED1 = 4;    // define PIN_LED1
    const int PIN_LED2 = 0;    // define PIN_LED2
    const int PIN_LED3 = 2;    // define PIN_LED3
    const int PIN_LED4 = 15;    // define PIN_LED4
    int duration = 0;    // define the initial value of the duration to be 0
    int distance = 0;   // define the initial value of the distance to be 0
    void setup() 
    {
      pinMode(TrigPin , OUTPUT); // set trigPin to output mode
      pinMode(EchoPin , INPUT); // set echoPin to input mode
      pinMode(PIN_LED1 , OUTPUT);  // set PIN_LED1 to output mode
      pinMode(PIN_LED2 , OUTPUT);  // set PIN_LED2 to output mode
      pinMode(PIN_LED3 , OUTPUT);  // set PIN_LED3 to output mode
      pinMode(PIN_LED4 , OUTPUT);  // set PIN_LED4 to output mode
      Serial.begin(115200);  // Open serial monitor at 115200 baud to see ping results.
    }
    void loop()
    {
    // make trigPin output high level lasting for 10μs to triger HC_SR04 
      digitalWrite(TrigPin , HIGH);
      delayMicroseconds(10);
      digitalWrite(TrigPin , LOW);
    // Wait HC-SR04 returning to the high level and measure out this waitting time
      duration = pulseIn(EchoPin , HIGH);
    // calculate the distance according to the time
      distance = (duration/2) / 28.5 ;
      Serial.print("Distance: ");
      Serial.print(distance); //Serial port print distance value
      Serial.println("cm");
      if ( distance <= 5 )
      {
        digitalWrite(PIN_LED1, HIGH);
      }
      else
      {
        digitalWrite(PIN_LED1, LOW);
      }
      if ( distance <= 10 )
      {
        digitalWrite(PIN_LED2, HIGH);
      }
      else
      {
        digitalWrite(PIN_LED2, LOW);
      }
      if ( distance <= 15 )
      {
        digitalWrite(PIN_LED3, HIGH);
      }
      else
      {
        digitalWrite(PIN_LED3, LOW);
      }
      if ( distance <= 20 )
      {
        digitalWrite(PIN_LED4, HIGH);
      }
      else
      {
        digitalWrite(PIN_LED4, LOW);
      }
    }     
    //**********************************************************************************


7.  Project result：

Compile and upload the code to ESP32, after the code is uploaded
successfully, power up with a USB cable, open the serial monitor and set
the baud rate to 115200. You will see that the serial port monitor
window will print outthe distance between the ultrasonic sensor and the
object, and the corresponding LED will light up when we move our hand in
front of the ultrasonic sensor.
